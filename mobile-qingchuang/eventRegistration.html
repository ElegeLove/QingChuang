<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>年会活动</title>
    <link rel="stylesheet" href="./mobileCss/eventRegistration.css">
    <link rel="stylesheet" href="./mobileCss/swiper.min.css">
    <script src="./mobileJs/jquery-3.4.1.min.js"></script>
    <script src="./mobileJs/rem.js"></script>
    <script src="./mobileJs/getApi.js"></script>
    <script src="./layer/layer.js"></script>
    <script src="./mobileJs/swiper.min.js"></script>
    <!-- <script type="text/javascript"
        src="https://webapi.amap.com/maps?v=1.3&key=456fb025b2e6a1718199483ae8edb6e9"></script> -->
    <script charset="utf-8"
        src="https://map.qq.com/api/js?v=2.exp&key=D6YBZ-EBJKI-D6CGS-5EGZB-RWE6V-5IFWP&libraries=convertor"></script>
    <!-- <script type="text/javascript"
        src="http://api.map.baidu.com/api?v=2.0&ak=HLxHEzoexmAsVld9m5pD9zuFnE5UbI8M"></script> -->
    <!-- <script type="text/javascript" src="http://developer.baidu.com/map/jsdemo/demo/convertor.js"></script> -->

    <!-- <iframe id="geoPage" width=0 height=0 frameborder=0 style="display:none;" scrolling="no"
        src="https://apis.map.qq.com/tools/geolocation?key=D6YBZ-EBJKI-D6CGS-5EGZB-RWE6V-5IFWP&referer=myapp">
    </iframe> -->
    <!-- <script src="http://api.map.baidu.com/api?v=1.2" type="text/javascript"></script> -->
</head>

<body>
    <div id="bigActivity">
        <div class="big_top">
            <div class="big_top_wen">
                <div class="big_top_bg">
                    <div class="title">
                        <div id="goback">
                            <img src="./mobileImg/back.png" alt="" srcset="">
                        </div>
                        <div class="title_text">年会活动</div>
                        <div id="share">
                            <img onclick="toshare()" src="./mobileImg/share.png" alt="" srcset="">
                        </div>
                    </div>
                    <div class="big_top_pic">
                        <img class="activity_img" src="" alt="" srcset="">
                    </div>
                </div>
                <div class="main">
                    <p class="main_title"></p>
                    <div class="main_text">
                        <div class="main_texts">
                            <p class="main_time"></p>
                            <p class="main_state"></p>
                        </div>
                    </div>
                    <div class="main_address">
                        <div class="main_address_text">
                            <p class="main_address_title"><a class="main_address_title_main"
                                    href="https://uri.amap.com/marker?position=经度,纬度&name=所在的位置名称"></a>
                            </p>
                            <img id="active_address" src="./mobileImg/icon_active_address.png" alt="" srcset="">
                        </div>
                    </div>
                </div>
                <div class="listMain">
                    <div
                        class="swiper-container swiper-container-initialized swiper-container-horizontal swiper-container-ios">
                        <div class="swiper-wrapper"
                            style="transition-duration: 0ms; transform: translate3d(0px, 0px, 0px);">
                            <div class="swiper-slide listBox swiper-slide-active">
                                <div class="list_items_main isSignIn" onclick="signIn()">
                                    <!-- <div class="icon_signIn"></div> -->
                                    <img src="./mobileImg/icon_signIn.png" alt="" srcset="">
                                    <p>签到</p>
                                </div>
                                <div class="list_items_main isActivityFlow" onclick="goActivityFlow()">
                                    <!-- <div class="icon_activityFlow"></div> -->
                                    <img src="./mobileImg/icon_activityFlow.png" alt="" srcset="">
                                    <p>会议议程</p>
                                </div>
                                <div class="list_items_main isOrderSet" onclick="goOrderSet()">
                                    <!-- <div class="icon_orderSet"></div> -->
                                    <img src="./mobileImg/icon_orderSet.png" alt="" srcset="">
                                    <p>座次安排</p>
                                </div>
                                <div class="list_items_main isSzhufucom" onclick="goSendBlessing()">
                                    <!-- <div class="icon_blessing"></div> -->
                                    <img src="./mobileImg/icon_blessing.png" alt="" srcset="">
                                    <p>送祝福</p>
                                </div>
                            </div>
                            <div class="swiper-slide listBox swiper-slide-next">
                                <div class="list_items_main isEnvelope" onclick="goRedEnvelope()">
                                    <!-- <div class="icon_redEnvelopes"></div> -->
                                    <img src="./mobileImg/icon_redEnvelopes.png" alt="" srcset="">
                                    <p>抢红包</p>
                                </div>
                                <div class="list_items_main isCommentary" onclick="goCommentary()">
                                    <img src="./mobileImg/icon_program.png" alt="" srcset="">
                                    <!-- <div class="icon_program"></div> -->
                                    <p>节目投票</p>
                                </div>
                                <div class="list_items_main" onclick="goSouvenir()">
                                    <img src="./mobileImg/icon_live.png" alt="" srcset="">
                                    <!-- <div class="icon_live"></div> -->
                                    <p>领取伴手礼</p>
                                </div>
                            </div>
                        </div>
                        <!-- Add Pagination -->
                        <div class="swiper-pagination swiper-pagination-bullets listTags">
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet"></span>
                        </div>
                    </div>
                </div>
                <div class="active_info">
                    <div class="active_info_box">
                        <div class="active_info_box1">
                            <div class="active_info_title">活动详情</div>
                            <div class="active_info_main"></div>
                        </div>
                    </div>
                </div>
                <div class="bottom_bg"></div>
            </div>
        </div>
        <!-- <div class="footer">
            <div>报名</div>
        </div> -->
    </div>
    <div class="modal-box">
        <div class="modal-box1">
            <div class="modal-box2">
                <!--顶部-->
                <div class="modal-box-top">
                    完善信息
                </div>
                <!--主体-->
                <div class="modal-box-content">
                    <div class="user_box"><img class="user_icon" src="./mobileImg/bigDraw_user.png" alt=""></div>
                    <div class="user_name">姓名 <input class="nameVal" type="text" autofocus="autofocus" value="嘻嘻哈哈~">
                    </div>
                    <div class="user_phone">手机号 <input class="phoneVal" type="tel" maxlength="11" placeholder="请输入手机号码">
                    </div>
                </div>
                <!--底部-->
                <div class="modal-box-bottom">
                    <div class="modal_btn">确定</div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    document.body.addEventListener('focusin', () => {
        // 软键盘弹出的事件处理
        this.isReset = false
    })
    document.body.addEventListener('focusout', () => {
        // 软键盘收起的事件处理
        this.isReset = true
        setTimeout(() => {
            // 当焦点在弹出层的输入框之间切换时先不归位
            if (this.isReset) {
                window.scroll(0, 0) // 失焦后强制让页面归位
            }
        }, 300)
    })
    var swiper = new Swiper('.swiper-container', {
        pagination: {
            el: '.swiper-pagination',
        },
    });
    // 滑动滚动条
    $(window).scroll(function () {
        if ($(window).scrollTop() >= $('.title').height() / 4 || $(window).scrollTop() < -6) {
            $('.title').css('background', '#a52219')
        } else {
            $('.title').css('background', '')
        }
    });
    function is_weixn() {
        var ua = navigator.userAgent.toLowerCase();
        if (ua.match(/MicroMessenger/i) == "micromessenger") {
            return true;
        } else {
            return false;
        }
    }
    $('.modal_btn').click(function () {
        ajax({
            url: "activity/bindUser", // url---->地址
            type: "POST", // type ---> 请求方式
            async: true, // async----> 同步：false，异步：true 
            data: { user_id: userId, user_name: $('.nameVal').val(), phone: $('.phoneVal').val(), activity_id: activityId },
            success: function (res) { //返回接受信息
                res = JSON.parse(res);
                if (res.code == 0) {
                    $('html,body').removeClass('ovfHiden');
                    $('.modal-box').css('display', 'none');
                    layer.msg(res.msg, {
                        icon: 1,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    });
                    apiInfo(activityId, userId);
                } else {
                    layer.msg(res.msg, {
                        icon: 2,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    });
                }
            },
            error: function (res) {
                layer.msg(res.msg, {
                    icon: 2,
                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                });
            }
        })
    })
    //sArgName表示要获取哪个参数的值
    var activityId = "";
    var userId = '';
    var code = '';
    var lat = '';
    var lng = '';
    var sHref = window.location.href;
    //CuPlayer.com提示：测试数据
    //实际情况是用window.location.href得到URL
    var args = sHref.split("?");
    var str = args[1];
    // args = str.split("&");
    // for (var i = 0; i < args.length; i++) {
    //     str = args[i];
    //     var arg = str.split("=");
    //     if (arg.length <= 1) continue;
    //     if (arg[0] == 'id') id = arg[1];
    //     if (arg[0] == 'active') active = arg[1];
    // }
    $('#goback').html('');
    $('#share').html('');
    if (sHref.indexOf("state") != -1) {
        if (localStorage.getItem("userId")) {
            args = str.split("&");
            for (var i = 0; i < args.length; i++) {
                str = args[i];
                var arg = str.split("=");
                if (arg.length <= 1) continue;
                if (arg[0] == 'state') activityId = arg[1];
            }
            // activityId = localStorage.getItem("activityId");
            userId = localStorage.getItem("userId");
            apiInfo(activityId, userId);
            getBao(userId, activityId)
            // getUserId(localStorage.getItem("userId"));
        } else {
            args = str.split("&");
            for (var i = 0; i < args.length; i++) {
                str = args[i];
                var arg = str.split("=");
                if (arg.length <= 1) continue;
                if (arg[0] == 'code') code = arg[1];
                if (arg[0] == 'state') activityId = arg[1];
            }
            // localStorage.setItem("activityId", activityId);
            getUserInfo(code, activityId)
        }
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    lat = position.coords.longitude;
                    lng = position.coords.latitude;
                },
                function (e) {
                    throw (e.message);
                }
            )
        }
        // apiInfo(activityId, userId)
    } else {
        args = str.split("&");
        for (var i = 0; i < args.length; i++) {
            str = args[i];
            var arg = str.split("=");
            if (arg.length <= 1) continue;
            if (arg[0] == 'id') activityId = arg[1];
        }
        $(window).attr('location', "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx58285919960eab1a&redirect_uri=https%3A%2F%2Fqingchuang.mx5918.com%2FeventRegistration.html&response_type=code&scope=snsapi_userinfo&state=" + activityId + "#wechat_redirect");
        // apiInfo(activityId, userId);
    }
    var is_get;
    let isGo = '';
    function apiInfo(activityId, userId) {
        ajax({
            url: "activity/activityDetail", // url---->地址
            type: "POST", // type ---> 请求方式
            async: true, // async----> 同步：false，异步：true 
            data: { activity_id: activityId, user_id: userId },
            success: function (res) { //返回接受信息
                res = JSON.parse(res);
                if (res.code == 0) {
                    is_get = res.data.is_get;
                    $('.main_title').text(res.data.activity_name);
                    let $imgUrl = $('<img class="activity_img" src=' + res.data.activity_img + ' alt="" srcset="">');
                    $('.activity_img').replaceWith($imgUrl);
                    // $('.activity_img').attr("src", res.data.activity_img);
                    // document.querySelector('.activity_img').src = res.data.activity_img;
                    // alert($('.activity_img')[0].src)
                    // alert(res.data.activity_img)
                    $('.main_time').text(res.data.activity_start_time + ' - ' + res.data.activity_end_time);
                    $('.main_address_title_main').text(res.data.activity_address);
                    $('.main_address_title_main').attr('href', 'https://uri.amap.com/marker?position=' + res.data.activity_lng + ',' + res.data.activity_lat + '&name=' + res.data.activity_address);
                    if (res.data.status == '1') {
                        $('.main_state').text('未开始')
                        $('.main_state').css('color', 'rgba(0,255,235,1)');
                    } else if (res.data.status == '2') {
                        $('.main_state').text('进行中')
                        $('.main_state').css('color', 'rgba(24,144,255,1)');
                    } else {
                        $('.main_state').text('已结束')
                        $('.main_state').css('color', 'rgba(0,0,0,0.25)');
                    }
                    if (res.data.is_message_wall == 2) {
                        $('.isSzhufucom').css('display', 'none');
                    }
                    if (res.data.is_red == 2) {
                        $('.isEnvelope').css('display', 'none');
                    }
                    if (res.data.is_program_appraise == 2) {
                        $('.isCommentary').css('display', 'none');
                    }
                    if (res.data.is_survey == 2) {
                        $('.isQuestionnaire').css('display', 'none');
                    }
                    if (res.data.is_word == 2) {
                        $('.isPresiding').css('display', 'none');
                    }
                    // if (res.data.is_join == 1) {
                    //     if (res.data.is_get == 1) {
                    //         $('.footer').html('<ul class="footer_list"><li class="activityFlow" onclick="goActivityFlow()">活动流程<li><li class="signIn">已签到<li><li class="orderSet" onclick="goOrderSet()">座次安排<li></ul>')
                    //     } else {
                    //         $('.footer').html('<ul class="footer_list"><li class="activityFlow" onclick="goActivityFlow()">活动流程<li><li class="signIn" onclick="signIn()">签到<li><li class="orderSet" onclick="goOrderSet()">座次安排<li></ul>')
                    //     }
                    // } else {
                    //     $('.footer').html('<div class="signUp" onclick="signUp()"><div>报名</div></div>')
                    // }
                    if (res.data.activity_content != '') {
                        $('.active_info_main').html(res.data.activity_content);
                    } else {
                        $('.active_info').css('display', 'none');
                        // var page = document.querySelector('#bigActivity');
                        var page = document.querySelector('.big_top');
                        var page1 = document.querySelector('.big_top_wen');
                        // // var page2 = document.querySelector('.big_top_bg');
                        // page.style.height = $(window).height() + 'px';
                        page.style.height = $(window).height() + 'px';
                        page1.style.height = $(window).height() + 'px';
                        // page2.style.height = $(window).height() + 'px';
                        // $('.big_top_wen').height = $(window).height() + 'px';
                        // $('.big_top_bg').height = $(window).height() + 'px';
                    }
                    isGo = res.data.is_join;
                } else {
                    layer.msg(res.msg, {
                        icon: 1,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    });
                }

            }
        })

    }

    $('#goback').click(function () {
        history.back(-1);
    })
    function getBao(userId, activityId) {
        ajax({
            url: "activity/isBao", // url---->地址
            type: "POST", // type ---> 请求方式
            async: true, // async----> 同步：false，异步：true 
            data: { user_id: userId, activity_id: activityId },
            success: function (res) { //返回接受信息
                res = JSON.parse(res);
                if (res.code == 0) {
                    if (res.data.is_bao == 2) {
                        getUserInfos(userId)
                    }

                }
            }
        })
    }
    // function getUserId(id) {
    //     ajax({
    //         url: "activity/changeId", // url---->地址
    //         type: "POST", // type ---> 请求方式
    //         async: true, // async----> 同步：false，异步：true 
    //         data: { user_id: id },
    //         success: function (res) { //返回接受信息
    //             res = JSON.parse(res);
    //             if (res.code == 0) {
    //                 userId = res.data.user_id
    //                 apiInfo(activityId, res.data.user_id);

    //             } else {
    //                 layer.msg(res.msg, {
    //                     icon: 1,
    //                     time: 2000 //2秒关闭（如果不配置，默认是3秒）
    //                 });
    //             }
    //         }
    //     })
    // }
    function getUserInfo(code, activityId) {
        ajax({
            url: "activity/wechat", // url---->地址
            type: "POST", // type ---> 请求方式
            async: true, // async----> 同步：false，异步：true 
            data: { code: code, activity_id: activityId },
            success: function (res) { //返回接受信息
                res = JSON.parse(res);
                if (res.code == 0) {
                    userId = res.data.user_id;
                    // getName(activityId,userId);
                    localStorage.setItem("userId", res.data.user_id);
                    // if (res.data.user_id) {
                    //     apiInfo(activityId, userId);
                    // } else {
                    apiInfo(activityId, userId);
                    getBao(userId, activityId)
                    // $('html,body').addClass('ovfHiden');
                    // $('.modal-box').css('display', 'block');
                    // $('.user_icon').attr('src', res.data.user_icon);
                    // $('.nameVal').val(res.data.user_name)
                    // }
                    // getUserId(userId);
                }
            },
            error: function (res) {
                layer.msg(res.msg, {
                    icon: 2,
                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                });
            }
        })
    }
    function getUserInfos(userId) {
        ajax({
            url: "activity/getUserInfo", // url---->地址
            type: "POST", // type ---> 请求方式
            async: true, // async----> 同步：false，异步：true 
            data: { user_id: userId },
            success: function (res) { //返回接受信息
                res = JSON.parse(res);
                if (res.code == 0) {
                    // if (res.data.user_id) {
                    //     apiInfo(activityId, userId);
                    // } else {
                    $('html,body').addClass('ovfHiden');
                    $('.modal-box').css('display', 'block');
                    $('.user_icon').attr('src', res.data.user_icon);
                    $('.nameVal').val(res.data.user_name)
                    // }
                    // getUserId(userId);
                }
            },
            error: function (res) {
                layer.msg(res.msg, {
                    icon: 2,
                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                });
            }
        })
    }
    function goSendBlessing() {
        if (isGo == 1) {
            $(window).attr('location', "sendBlessing.html?activityId=" + activityId + "&userId=" + userId)
        } else {
            layer.msg('您还未报名该活动', {
                icon: 2,
                time: 2000 //2秒关闭（如果不配置，默认是3秒）
            });
        }
    }
    function goCommentary() {
        if (isGo == 1) {
            $(window).attr('location', "commentary.html?activityId=" + activityId + "&userId=" + userId)
        } else {
            layer.msg('您还未报名该活动', {
                icon: 2,
                time: 2000 //2秒关闭（如果不配置，默认是3秒）
            });
        }
    }
    function goOrderSet() {
        if (isGo == 1) {
            $(window).attr('location', "orderSet.html?activityId=" + activityId + "&userId=" + userId)
        } else {
            layer.msg('您还未报名该活动', {
                icon: 2,
                time: 2000 //2秒关闭（如果不配置，默认是3秒）
            });
        }
    }
    function goQuestionnaire() {
        if (isGo == 1) {
            $(window).attr('location', "questionnaire.html?activityId=" + activityId + "&userId=" + userId)
        } else {
            layer.msg('您还未报名该活动', {
                icon: 2,
                time: 2000 //2秒关闭（如果不配置，默认是3秒）
            });
        }
    }
    function goSouvenir() {
        if (isGo == 1) {
            $(window).attr('location', "souvenir.html?activityId=" + activityId + "&userId=" + userId)
            // if (is_get == 1) {
            // } else {
            //     $('html,body').addClass('ovfHiden');
            //     layer.open({
            //         type: 1,
            //         title: '提示',
            //         content: '请签到过后再执行该操作！',
            //         btn: ['确定'],
            //         scrollbar: false,
            //         shadeClose: true,
            //         btn1: function (index) {
            //             $('html,body').removeClass('ovfHiden');
            //             layer.close(index);
            //         },
            //     });
            // }
        } else {
            layer.msg('您还未报名该活动', {
                icon: 2,
                time: 2000 //2秒关闭（如果不配置，默认是3秒）
            });
        }
    }
    function goRedEnvelope() {
        if (isGo == 1) {
            $(window).attr('location', "redEnvelope.html?activityId=" + activityId + "&userId=" + userId)
        } else {
            layer.msg('您还未报名该活动', {
                icon: 2,
                time: 2000 //2秒关闭（如果不配置，默认是3秒）
            });
        }
    }
    function goHostWord() {
        if (isGo == 1) {
            ajax({
                url: "activity/word", // url---->地址
                type: "POST", // type ---> 请求方式
                async: true, // async----> 同步：false，异步：true 
                data: { activity_id: activityId, user_id: userId },
                success: function (res) { //返回接受信息
                    res = JSON.parse(res);
                    if (res.code == 0) {
                        $(window).attr('location', "hostWord.html?activityId=" + activityId + "&userId=" + userId);
                    } else {
                        layer.msg(res.msg, {
                            icon: 2,
                            time: 2000 //2秒关闭（如果不配置，默认是3秒）
                        });
                    }

                }
            })
        } else {
            layer.msg('您还未报名该活动', {
                icon: 2,
                time: 2000 //2秒关闭（如果不配置，默认是3秒）
            });
        }
    }
    function goActivityFlow() {
        if (isGo == 1) {
            $(window).attr('location', "activityFlow.html?activityId=" + activityId)
        } else {
            layer.msg('您还未报名该活动', {
                icon: 2,
                time: 2000 //2秒关闭（如果不配置，默认是3秒）
            });
        }
    }
    function js_writeOff() {
        location.href = 'https://www.js_writeOff.com';
    }
    function signIn() {
        if (isGo == 1) {
            ajax({
                url: "activity/sign", // url---->地址
                type: "POST", // type ---> 请求方式
                async: true, // async----> 同步：false，异步：true 
                data: { activity_id: activityId, user_id: userId, lat: lat, lng: lng },
                success: function (res) { //返回接受信息
                    res = JSON.parse(res);
                    if (res.code == 0) {
                        apiInfo(activityId, userId);
                        $('html,body').addClass('ovfHiden');
                        layer.open({
                            type: 1,
                            title: '提示',
                            content: res.msg,
                            btn: ['领取伴手礼'],
                            scrollbar: false,
                            shadeClose: true,
                            btn1: function (index) {
                                $('html,body').removeClass('ovfHiden');
                                layer.close(index);
                                $(window).attr('location', "souvenir.html?activityId=" + activityId + "&userId=" + userId);
                            },
                        });
                    } else {
                        $('html,body').addClass('ovfHiden');
                        layer.open({
                            type: 1,
                            title: '提示',
                            content: res.msg,
                            btn: ['确定'],
                            scrollbar: false,
                            shadeClose: true,
                            btn1: function (index) {
                                $('html,body').removeClass('ovfHiden');
                                layer.close(index);
                            },
                        });

                    }
                    $('.layui-layer-btn0').css('background', 'rgba(250, 202, 43, 1)')

                },
                error: function (res) {
                    layer.msg(res.msg, {
                        icon: 2,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    });
                }
            })
        } else {
            layer.msg('您还未报名该活动', {
                icon: 2,
                time: 2000 //2秒关闭（如果不配置，默认是3秒）
            });
        }

    }
    function toshare() {
        let text = $('.main_title').text();
        location.href = 'https://www.js_share.com?id=' + activityId + '&title=' + JSON.stringify(text);
    }
    function signUp() {
        $('html,body').addClass('ovfHiden');
        layer.open({
            type: 1,
            title: '提示',
            content: '确定报名参加本次活动吗？',
            btn: ['取消', '确定'],
            scrollbar: false,
            shadeClose: true,
            btn1: function (index) {
                layer.close(index);
                $('html,body').removeClass('ovfHiden');
            },
            btn2: function (index) {
                $('html,body').removeClass('ovfHiden');
                getName(activityId, userId);
            },
        });

    }
    function getName(activityId, userId) {
        ajax({
            url: "activity/joinActivity", // url---->地址
            type: "POST", // type ---> 请求方式
            async: true, // async----> 同步：false，异步：true 
            data: { activity_id: activityId, user_id: userId },
            success: function (res) { //返回接受信息
                res = JSON.parse(res);
                if (res.code == 0) {
                    layer.msg(res.msg, {
                        icon: 1,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    });
                    apiInfo(activityId, userId)
                } else {
                    layer.msg(res.msg, {
                        icon: 1,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    });
                }

            }
        })
    }

</script>

</html>